project_spec.md

# Project: Inmate Concierge ERP (Master Plan v4.0)
# Goal: Mailroom-to-Reply Closed Loop System

## 1. 프로젝트 핵심 철학: "완벽한 피드백 루프"
이 시스템은 우편물 도착(Input)에서 시작하여, 처리 결과를 담은 답장 발송(Output)으로 끝나는 **'닫힌 업무 루프(Closed Loop)'**를 지향한다.
특히 **[일일 마감 탭]**은 하루의 업무를 검증하고, 고객에게 보낼 메시지를 확정하여 대량으로 출력하는 **최종 관문**이다.

---

## 2. 전체 시스템 구조도 (Full Lifecycle)

1.  **우편 도착 (Mailroom):** 편지 봉투/내용물 일괄 스캔 & 업로드 -> 자동 OCR 분석(gpt-4o-mini).
2.  **검수/배당 (Dispatch):** 오퍼레이터가 OCR 내용 검수 -> 직원에게 티켓 생성 및 배당.
3.  **업무 처리 (Staff):** 직원이 배당된 티켓 내에서 [도서/배팅/물품] 장바구니 담기 및 처리.
    - *재고 없는 물품은 '구매요청' 상태로 자동 전환.*
4.  **중간 관리 (Procurement/Sports):**
    - **발주팀:** 물건 구매 -> 입고 -> **[교도소 사전등록]** (이때 발송인 지정).
    - **스포츠팀:** 크롤링된 경기 결과 확인 -> **[결과 승인]** -> 당첨금 자동 정산.
5.  **답변 등록 (Reply Gen):** 업무 처리가 끝난 티켓에 대해 AI가 "처리 결과 안내문"을 작성하여 등록.
6.  **일일 마감 (Closing):** 관리자가 등록된 답변과 정산 내역을 최종 확인하고 **[마감 승인]** -> 자금 동결.
7.  **일괄 출력 (Batch Output):** 마감된 건들을 교도소별/방별로 묶어 **A4 답장 일괄 출력** -> 우편 발송.

---

## 3. 상세 기능 명세 (Feature Specs)

### [Phase 1: 우편실 & 검수 (Mailroom & Dispatch)]
- **Incoming_Letters 테이블:** 원본 이미지, OCR 텍스트, 상태 관리.
- **Bulk Upload:** 사진 연속 촬영 후 일괄 업로드 기능.
- **Dispatch UI:** 좌측(이미지) vs 우측(OCR+회원검색). 직원을 지정하여 `Tasks` 생성(배당).

### [Phase 2: 업무 처리 & 발주 (Staff & Procurement)]
- **Multi-Item Ticket:** 티켓 하나에 도서, 배팅, 물품 등 여러 `task_items`가 존재.
- **Procurement Flow:** `구매요청` -> `구매완료` -> `도착` -> `사전등록` -> `배송대기`.
- **Sender Assignment:** 사전등록 단계에서 '발송인(Sender)'을 지정하며, 이는 추후 송장/답장 출력 시 반영됨.

### [Phase 3: 스포츠 관리 (Sports Ops)]
- **Auto Crawling:** 경기 결과를 외부에서 크롤링하여 가져옴.
- **Manual Verification:** 크롤링된 결과가 맞는지 오퍼레이터가 **[승인]** 버튼을 눌러야만 배당금 지급 로직 실행.

### [Phase 4: 마감 및 출력 (Closing & Output)]
- **Reply Generation:** `gpt-4o-mini`를 사용하여 처리 내역(성공/실패/잔액)을 바탕으로 친절한 서신체 답장 자동 생성.
- **Closing Tab:**
  - **좌측:** 오늘 처리된 티켓 리스트 및 수지 현황.
  - **우측:** AI가 쓴 답장 미리보기 및 수정.
- **Batch Print:** '마감(Closed)' 상태인 티켓을 선택하여 **[일괄 출력]** 클릭 시, A4 용지에 답장 서식으로 PDF 병합 출력.

---

## 4. 데이터베이스 및 기술 요구사항

- **Database (Supabase):**
  - `tasks`: `reply_content`(답장내용), `closed_at`, `closed_by` 컬럼 필수.
  - `task_items`: `procurement_status`, `sender_name` 컬럼 필수.
  - `games`: `result_score`, `is_verified` 컬럼 필수.
- **AI Integration:**
  - OCR 및 답장 생성 시 `gpt-4o-mini` 모델 사용 (비용 절감).
  - 이미지 업로드 시 클라이언트 리사이징 필수.
- **Security:**
  - 직원(Staff)은 원가 조회 불가.
  - 마감(Closed)된 티켓은 수정 불가(Read Only).

---

## 5. 지시 사항
이 설계도를 바탕으로 **DB 스키마를 재검토**하고, **[우편 도착 -> 배당 -> 처리 -> 마감 -> 출력]**으로 이어지는 파이프라인을 구축하라.
특히 **'일일 마감' 탭에서 관리자의 승인이 없으면 절대 답장이 출력되지 않도록** 안전장치를 구현하라.# Pro

ject: Inmate Concierge ERP (Master Plan v4.0)
# Keyword: Daily Closing, AI Reply Generation, Batch Output

# Project: Inmate Concierge ERP (Master Plan v3.0)
# Keyword: Mailroom First, Operator Dispatch, Batch Logistics

## 1. 프로젝트 개요 및 핵심 워크플로우
이 시스템은 우편물 도착부터 배송까지의 전 과정을 관리한다.
가장 큰 특징은 **'선(先) 스캔, 후(後) 배당'** 시스템이다. 편지가 도착하면 일단 전부 스캔하여 디지털화하고, 오퍼레이터가 이를 검수하여 직원에게 티켓을 생성/배당한다.

**[직급 체계]**
1. **Staff (직원):** 배당받은 티켓 처리, 고객 응대, 댓글 소통.
2. **Operator (오퍼레이터/중간관리자):** OCR 검수 및 배당, 발주/입금 관리, 스포츠 결과 승인.
3. **Manager (최고관리자):** 최종 승인, 전체 자금/매출 관리.

---

## 2. 데이터베이스 구조 변화 (New Schema)
1. **Incoming_Letters (신규):** 우편실 도착 데이터.
   - `id`, `image_url` (원본), `ocr_text` (추출텍스트), `status` (uploaded, verified, assigned).
2. **Tasks (티켓):** `assignee_id` (담당 직원) 컬럼이 핵심. 편지 검수 완료 시 생성됨.
3. **Task_Items:** `sender_name` (사전등록 시 지정된 발송인) 컬럼 추가.
4. **Games:** `result_score` (크롤링된 결과), `is_verified` (관리자 확인여부) 추가.

---

## 3. 단계별 업무 시나리오 (Detailed Scenario)

### [Phase 1: 우편물 도착 및 디지털화 (Mailroom)]
- **행위자:** 아르바이트 또는 직원
- **기능:**
  - **Bulk Upload:** 편지 봉투 및 내용물을 연속 촬영하여 일괄 업로드.
  - **Auto OCR:** 업로드 즉시 백그라운드에서 OCR 수행 (gpt-4o-mini).
  - 이때는 아직 티켓이 생성되지 않은 'Raw Data' 상태.

### [Phase 2: 검수 및 배당 (Triage & Dispatch)]
- **행위자:** 오퍼레이터 (Operator)
- **화면:** 좌측(이미지) / 우측(OCR 텍스트 + 회원검색 + 직원선택).
- **로직:**
  1. OCR된 텍스트 오타 수정 및 회원 매칭.
  2. 담당 직원(Staff)을 선택하고 **[배당(Assign)]** 버튼 클릭.
  3. **이 시점에 비로소 `Tasks` 티켓이 생성됨.**

### [Phase 3: 직원 업무 처리 (Staff Processing)]
- **행위자:** 직원 (Staff)
- **화면:** **[나의 할 일(My Tasks)]**
  - 자신에게 배당된 티켓만 리스트에 뜸.
  - 티켓을 열어 고객 요청사항(도서, 경기, 물품 등)을 장바구니에 담고 [작성 완료] 처리.
  - 주요 알림: "새로운 배당 n건", "관리자 댓글 알림".

### [Phase 4: 스포츠 결과 처리 (Sports Ops)]
- **행위자:** 오퍼레이터
- **기능:**
  - **Auto Crawling:** 네이버/포털 스포츠 결과를 주기적으로 크롤링하여 DB에 임시 저장.
  - **Result Verification: **"[결과처리] 버튼 누르면 크롤링되고, 크롤링된 결과를 창으로 뜨게함. 확인 이후 [결과 승인]
  - 오퍼레이터가 **[결과 승인]**을 눌러야만 배팅 정산(지급)이 실행됨. (오류 방지) -> 당첨 안내 바로 자동 알림

### [Phase 5: 발주 및 사전등록 (Procurement & Pre-reg)]
- **행위자:** 오퍼레이터
- **기능:**
  - **발송인 지정(Sender Assignment):** 물품 도착 후 교도소 사전등록 단계에서, **"이 물건은 '김철수' 명의로 보낸다"**라고 시스템에 입력/지정함.
  - 이 정보는 나중에 송장 출력 시 그대로 반영됨.

### [Phase 6: 물류 및 발송 (Batch Logistics)]
- **행위자:** 물류팀
- **기능:**
  - **No More Labels:** 낱장 송장(라벨) 대신 **[일일 발송 대장(Daily Manifest)]** 출력.
  - **A4 Manifest Output:**
    - A4 용지에 [발송인별] 또는 [교도소별]로 묶어서 출력.
    - 예: "발송인 김철수 처리분 (총 5건) -> 1. 홍길동(서울구치소) - 수학의정석 / 2. 임꺽정..."
  - 이 리스트를 보고 포장하여 발송 처리.

### [Phase 7: 통합 관제 및 정산 (Control Tower)]
- **행위자:** 오퍼레이터 이상
- **기능:**
  - **일일 정산 페이지:**
    - 오늘의 티켓 유입량(검수량), 처리 완료량.
    - 입금 총액 vs 출금(환불/배당) 총액 = **순매출 현황**.
    - 미마감(Pending) 티켓 현황 모니터링.

---

## 4. 직급별 대시보드 구조 (Role-Based View)

### A. 일반 직원용 (Staff View)
1. **나의 할 일:** 나에게 배당되었으나 아직 `Processing` 중인 티켓.
2. **미마감 알림:** 퇴근 전 처리해야 할 잔여 업무.
3. **댓글/소통:** 내 티켓에 달린 관리자 지시사항(Comments) 알림.

### B. 오퍼레이터/관리자용 (Operator View)
1. **검수 대기열:** 우편실에서 올라온 Raw 이미지 리스트 (빨리 배당해야 함).
2. **승인/결재:** 직원이 올린 구매요청, 배팅결과 승인 대기.
3. **입금 확인:** 무통장 입금 매칭 필요 건.
4. **일일 정산표:** 오늘의 자금 및 업무 흐름 요약 차트.

---

## 5. 지시 사항
위의 **'선(先) 스캔 - 후(後) 배당'** 프로세스를 기반으로 시스템을 구축하라.
특히 **'Pre-registration(사전등록)' 단계에서 저장된 `Sender` 정보가 마지막 'A4 Manifest' 출력 시 정확히 반영**되도록 DB 관계를 설정하라.
스포츠 크롤링은 외부 스크립트 연동을 고려하여 `Manual Approval` 절차를 반드시 UI에 포함시켜라.

## 1. 프로젝트 핵심 철학: "완벽한 피드백 루프"
이 시스템은 우편물 도착(Input)에서 시작하여, 처리 결과를 담은 답장 발송(Output)으로 끝나는 **'닫힌 업무 루프(Closed Loop)'**를 지향한다.
특히 **[일일 마감 탭]**은 하루의 업무를 검증하고, 고객에게 보낼 메시지를 확정하여 대량으로 출력하는 **최종 관문**이다.

---

## 2. 일일 마감 프로세스 (The Daily Closing Workflow)

### [Step 1: 마감 대기열 (Review Queue)]
- **위치:** `/dashboard/closing` (오퍼레이터 이상 접근 가능)
- **대상:** 오늘 업무 처리가 완료된(`status='processed'`) 모든 티켓.
- **기능:**
  - 티켓별 처리 내역 요약 (예: 도서 2권 구매, 배팅 1건 승리).
  - **AI 답장 미리보기:** 시스템이 `task_items` 결과를 바탕으로 자동 생성한 답장 문구 표시.
    - *("홍길동님, 요청하신 수학의 정석 구매 완료했습니다. 배팅하신 맨유 경기는 승리하여 15,000P 지급되었습니다. 현재 잔액: 32,000P")*
  - **Action:** 내용이 정확하면 **[마감 승인]** 버튼 클릭.

### [Step 2: 자금 및 재고 동결 (Financial Lock)]
- [마감 승인]이 눌리는 순간 발생하는 트랜잭션:
  1. 해당 티켓의 모든 포인트 변동 내역이 '확정' 상태로 변경 (수정 불가).
  2. 도서 재고 및 배팅 정산 내역 최종 확정.
  3. 티켓 상태 변경: `processed` -> `closed`.

### [Step 3: 일괄 출력 및 발송 (Batch Output)]
- **위치:** `/dashboard/closing/print`
- **기능:** `답변 등록` 상태인 티켓들을 순서에 따라 정렬. / 답변 완료와 마감은 다르다. 예를 들면 손님으로부터 도서 주문이 왔으면 도서 주문이 정상 접수되었음을 알려주고, 이후에 배송까지 해야하기 때문. 배송을 마친 후에야 마감 처리를 할거라 "답변 등록" 시스템이 필요할듯 함. -> "답변 등록" 후 "답변 출력"시 "답변 완료"
- **출력물 (A4 Reply Letter):**
  - 상단: 수용자 정보
  - 본문: AI가 작성하고 관리자가 승인한 **'처리 결과 안내문'**.
  - 하단: 잔액 현황 및 다음 배팅 정보(광고/정보성 멘트 추가 가능).
- **인쇄 방식:** 버튼 하나로 선택한 50명분의 답장을 PDF로 병합하여 일괄 출력. 기존 양식을 두면 될듯. 혹은 양식을 웹에서 수정할 수 있게끔 하거나.

---

## 3. 전체 시스템 구조도 (Full Lifecycle)

1.  **우편 도착 (Mailroom):** 편지 스캔 & 업로드 -> OCR 분석.
2.  **검수/배당 (Dispatch):** 오퍼레이터가 내용 확인 후 직원에게 티켓 생성 및 배당.
3.  **업무 처리 (Staff):** 직원이 티켓 내에서 [도서/배팅/물품] 장바구니 담기 및 처리.
    - *발주 필요한 건은 구매요청 탭으로 자동 분기.*
4.  **중간 관리 (Procurement/Sports):**
    - 발주팀: 물건 구매 및 입고, 교도소 사전등록.
    - 스포츠팀: 경기 결과 입력 및 승인.
5.  **일일 마감 (Closing - NEW):**
    - 관리자가 처리 결과 확인 -> **답장 생성 승인** -> 자금 동결.
6.  **최종 발송 (Outbound):**
    - 마감된 건들에 대해 **답장 편지 일괄 출력** -> 우편 발송.

---

## 4. 데이터베이스 및 기능 요구사항

- **Table Update (`Tasks`):**
  - `reply_content`: AI가 생성한 답장 본문 저장 컬럼.
  - `closed_at`: 마감 일시.
  - `closed_by`: 마감 승인자 ID.

- **AI Prompt Engineering (Reply Gen):**
  - `gpt-4o-mini`를 사용하여, `task_items`의 수행 결과와 회원의 `balance`를 입력받아 **"친절하고 명확한 서신체"**로 답장을 작성하는 프롬프트 구현.

- **UI/UX:**
  - 마감 탭은 화면을 좌우로 분할하여, **[좌측: 처리 내역 / 우측: 생성된 답장]**을 동시에 보며 빠르게 검수할 수 있게 할 것.

---

## 5. 지시 사항
이 설계도는 **티켓의 생성부터 소멸(답장 발송)**까지의 완벽한 생애 주기를 담고 있다.
기존의 파편화된 기능들을 이 **[일일 마감 및 답장 발송]** 파이프라인으로 수렴시키도록 시스템을 통합하라.
특히 **'관리자의 마감 승인'이 없으면 절대 답장이 출력되지 않도록** 안전장치를 마련하라.