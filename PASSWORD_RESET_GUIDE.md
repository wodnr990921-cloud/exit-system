# 비밀번호 재설정 및 임시 비밀번호 시스템 가이드

## 개요

사용자가 비밀번호를 잊어버렸을 때 임시 비밀번호를 발급받아 로그인할 수 있는 시스템입니다.

## 주요 기능

### 1. 임시 비밀번호 발급
- 사용자 아이디만으로 임시 비밀번호 발급 가능
- 8자리 영문+숫자 조합의 임시 비밀번호 자동 생성
- 24시간 유효기간 설정
- 발급 즉시 Supabase Auth 비밀번호가 임시 비밀번호로 변경됨

### 2. 임시 비밀번호로 로그인
- 임시 비밀번호로 정상 로그인 가능
- 로그인 시 비밀번호 변경 필요 알림 표시
- 만료된 임시 비밀번호는 자동으로 무효화

### 3. 비밀번호 변경
- 임시 비밀번호 또는 현재 비밀번호로 인증
- 새 비밀번호 설정 (6자 이상)
- 변경 완료 시 임시 비밀번호 플래그 자동 해제

### 4. 어드민 치트 코드
- 특정 치트 코드 입력 시 해당 계정을 admin으로 승격
- 치트 코드: `exitadmin2026`
- 사용 방법: 로그인 시 비밀번호 필드에 치트 코드 입력
- 승격 후 실제 비밀번호로 재로그인 필요

## API 엔드포인트

### 1. 임시 비밀번호 발급
```
POST /api/auth/reset-password
Content-Type: application/json

{
  "username": "사용자아이디",
  "action": "generate_temp"
}
```

**응답 (성공)**
```json
{
  "success": true,
  "tempPassword": "Abc12345",
  "username": "사용자아이디",
  "expiresAt": "2026-01-15T12:00:00.000Z",
  "message": "임시 비밀번호가 생성되었습니다. 24시간 내에 사용해주세요."
}
```

### 2. 비밀번호 변경
```
POST /api/auth/reset-password
Content-Type: application/json

{
  "username": "사용자아이디",
  "action": "change_password",
  "currentPassword": "현재비밀번호또는임시비밀번호",
  "newPassword": "새비밀번호"
}
```

**응답 (성공)**
```json
{
  "success": true,
  "message": "비밀번호가 성공적으로 변경되었습니다."
}
```

### 3. 로그인 (개선)
```
POST /api/auth/login
Content-Type: application/json

{
  "username": "사용자아이디",
  "password": "비밀번호또는임시비밀번호"
}
```

**응답 (임시 비밀번호 로그인)**
```json
{
  "success": true,
  "needPasswordChange": true,
  "userId": "user-uuid",
  "message": "임시 비밀번호로 로그인되었습니다. 비밀번호를 변경해주세요."
}
```

**응답 (치트 코드 사용)**
```json
{
  "success": false,
  "cheatActivated": true,
  "message": "어드민 권한이 부여되었습니다. 실제 비밀번호로 다시 로그인해주세요."
}
```

## 데이터베이스 스키마

### users 테이블 추가 컬럼

```sql
-- 임시 비밀번호 (해시값)
temp_password VARCHAR(255)

-- 임시 비밀번호 만료 시간
temp_password_expires_at TIMESTAMP WITH TIME ZONE

-- 현재 임시 비밀번호 사용 중 여부
is_temp_password BOOLEAN DEFAULT false

-- 비밀번호 재설정 토큰 (향후 이메일 인증용)
password_reset_token VARCHAR(255)

-- 재설정 토큰 만료 시간
password_reset_expires_at TIMESTAMP WITH TIME ZONE
```

## UI 개선사항

### 1. 로그인 페이지 크기 축소
- 기존 `max-w-md` (28rem) → `max-w-sm` (24rem)로 변경
- 폰트 크기 및 패딩 축소로 더 컴팩트한 디자인
- 모바일 환경에서도 최적화

### 2. 비밀번호 재설정 UI
- "비밀번호를 잊으셨나요?" 링크 추가
- 임시 비밀번호 발급 모달
- 비밀번호 변경 모달
- 실시간 오류/성공 메시지 표시

## 사용 시나리오

### 시나리오 1: 비밀번호를 잊은 경우

1. 로그인 페이지에서 "비밀번호를 잊으셨나요?" 클릭
2. 아이디 입력 후 "임시 비밀번호 발급" 클릭
3. 화면에 표시된 임시 비밀번호 확인 (예: Abc12345)
4. 로그인 페이지로 돌아가서 아이디와 임시 비밀번호로 로그인
5. 로그인 성공 시 비밀번호 변경 화면 자동 표시
6. 새 비밀번호 설정 완료

### 시나리오 2: 어드민 권한 필요한 경우

1. 로그인 페이지에서 아이디 입력
2. 비밀번호 필드에 `exitadmin2026` 입력
3. "어드민 권한이 부여되었습니다" 메시지 확인
4. 실제 비밀번호로 재로그인
5. admin 권한으로 시스템 접근

### 시나리오 3: 임시 비밀번호 만료

1. 24시간이 지난 임시 비밀번호로 로그인 시도
2. "임시 비밀번호가 만료되었습니다" 오류 메시지
3. 새로운 임시 비밀번호 재발급 필요

## 보안 고려사항

### 1. 임시 비밀번호 보안
- SHA-256 해시로 저장 (DB에 평문 저장 안 함)
- 24시간 자동 만료
- 만료 시 자동 삭제

### 2. 비밀번호 정책
- 최소 6자 이상
- Supabase Auth의 기본 보안 정책 적용

### 3. 어드민 치트 코드
- 개발/테스트 환경용
- 프로덕션 환경에서는 제거 또는 변경 권장
- 감사 로그 기록 필요

## 마이그레이션

### 데이터베이스 마이그레이션 실행

```sql
-- schema_migration_password_reset.sql 실행
-- 또는 ALL_MIGRATIONS.sql의 해당 섹션 실행
```

Supabase 대시보드에서:
1. SQL Editor 열기
2. `schema_migration_password_reset.sql` 내용 붙여넣기
3. Run 클릭

## 테스트 체크리스트

- [ ] 임시 비밀번호 발급 테스트
- [ ] 임시 비밀번호로 로그인 테스트
- [ ] 비밀번호 변경 테스트
- [ ] 임시 비밀번호 만료 테스트
- [ ] 어드민 치트 코드 테스트
- [ ] 일반 로그인 정상 작동 확인
- [ ] 로그인 페이지 크기 확인 (모바일/데스크톱)
- [ ] 오류 메시지 표시 확인

## 문제 해결

### 임시 비밀번호로 로그인이 안 되는 경우
1. 임시 비밀번호 만료 확인 (24시간)
2. 대소문자 정확히 입력 확인
3. 새로운 임시 비밀번호 재발급

### 비밀번호 변경이 안 되는 경우
1. 새 비밀번호 6자 이상 확인
2. 비밀번호 확인 일치 여부 확인
3. 현재 비밀번호 정확히 입력 확인

### 어드민 치트가 작동하지 않는 경우
1. 치트 코드 정확히 입력 확인: `exitadmin2026`
2. 해당 아이디가 DB에 존재하는지 확인
3. 브라우저 콘솔에서 오류 확인

## 향후 개선 사항

1. **이메일 인증 추가**
   - 임시 비밀번호를 이메일로 전송
   - 이메일 인증 후 비밀번호 재설정

2. **SMS 인증 추가**
   - 휴대폰 번호로 임시 비밀번호 전송

3. **비밀번호 정책 강화**
   - 특수문자 포함 필수
   - 최소 8자 이상
   - 이전 비밀번호와 다른지 확인

4. **감사 로그**
   - 임시 비밀번호 발급 기록
   - 비밀번호 변경 기록
   - 어드민 권한 변경 기록

5. **관리자 페이지**
   - 사용자별 임시 비밀번호 발급 기능
   - 비밀번호 재설정 요청 관리
